default:
  image: node:16.13.2-alpine
  interruptible: true
  before_script:
    - npm i -g pnpm@6.x
    - pnpm config set store-dir .pnpm-store
    - apk add bash

stages:
  - setup
  - build
  - test
  - release
  - staging
  - production

workflow:
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /^chore\(release\)\:.+$/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /^chore\:.+$/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /^docs\:.+$/
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: always

# Set branch-based environment variables -- shared for all jobs
variables:
  NODE_ENV: CI
  GL_TOKEN: ${CI_GIT_USER_PERSONAL_ACCESS_TOKEN}

.dependencies_cache:
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .npm
      - .pnpm-store
      - node_modules
      - "packages/*/node_modules"
      - "packages/*/.npm"
      - "apps/*/node_modules"
      - "apps/*/.npm"
    policy: pull

# cache node_modules across pipelines based on "pnpm-lock.yaml"
setup:
  stage: setup
  script:
    - pnpm i --ignore-scripts
    - pnpm run prettier
  extends: .dependencies_cache
  allow_failure: false
  cache:
    policy: pull-push

# CI -- continuous integration via build + tests
build-all:
  stage: build
  script:
    # build: libs, apis and lambdas
    - npm run build
  extends: .dependencies_cache
  needs:
    - setup
  when: on_success
